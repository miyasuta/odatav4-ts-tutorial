sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/thirdparty/sinon","sap/base/Log"],function(e,r,t){"use strict";var n=r.sandbox.create(),a,o,i="sap/ui/core/tutorial/odatav4",s="sap.ui.core.tutorial.odatav4.mockserver",u=/services.odata.org\/TripPinRESTierService/;return{init:function(){return y().then(function(){n.useFakeServer();n.server.autoRespond=true;n.server.respondWith(u,U);r.FakeXMLHttpRequest.useFilters=true;r.FakeXMLHttpRequest.addFilter(function(e,r){return!u.test(r)});t.setLevel(3,s);t.info("Running the app with mock data",s)})},stop:function(){r.FakeXMLHttpRequest.filters=[];r.FakeXMLHttpRequest.useFilters=false;n.restore();n=null}};function c(e){var r=e.match(/http.+\(S\(.+\)\)\//);if(!Array.isArray(r)||r.length<1){throw new Error("Could not find a base URL in "+e)}return r[0]}function l(e){for(var r=0;r<a.length;r++){if(a[r].UserName===e){return r}}return-1}function f(e){var r=e.match(/({.+})/);if(!Array.isArray(r)||r.length!==2){throw new Error("Could not find any user data in "+e)}return JSON.parse(r[1])}function p(e){var r=[];r=e.match(/People\('(.*)'\)/);return r?r[1]:undefined}function d(e){return l(e)<0}function h(e){return JSON.stringify({error:{code:"409",message:"There is already a user with user name '"+e+"'.",target:"UserName"}})}function m(e){return JSON.stringify({error:{code:"404",message:"There is no user with user name '"+e+"'.",target:"UserName"}})}function v(e){return[200,{"Content-Type":"application/json; odata.metadata=minimal","OData-Version":"4.0"},e]}function y(){var r=new Promise(function(e,r){var n=sap.ui.require.toUrl(i+"/localService/metadata.xml"),a=new XMLHttpRequest;a.onload=function(){if(a.status===404){var i="resource "+n+" not found";t.error(i,s);r(new Error(i,s))}o=this.responseText;e()};a.onerror=function(){var e="error loading resource '"+n+"'";t.error(e,s);r(new Error(e,s))};a.open("GET",n);a.send()}),n=new Promise(function(r,n){var o=sap.ui.require.toUrl(i+"/localService/mockdata/people.json"),u=new e(o);u.attachRequestCompleted(function(e){if(e.getParameter("errorobject")&&e.getParameter("errorobject").statusCode===404){var i="resource '"+o+"' not found";t.error(i,s);n(new Error(i,s))}a=this.getData().value;r()});u.attachRequestFailed(function(){var e="error loading resource '"+o+"'";t.error(e,s);n(new Error(e,s))})});return Promise.all([r,n])}function g(e,r){var t,n,a=[].concat(r),o=e.url.match(/\$skip=(\d+)&\$top=(\d+)/);if(Array.isArray(o)&&o.length>=3){t=o[1];n=o[2];return r.slice(t,t+n)}return a}function w(e,r){var t,n,a=[].concat(r),o=e.url.match(/\$orderby=(\w*)(?:%20(\w*))?/);if(!Array.isArray(o)||o.length<2){return a}t=o[1];n=o[2]||"asc";if(t!=="LastName"){throw new Error("Filters on field "+t+" are not supported.")}a.sort(function(e,r){var t=e.LastName.toUpperCase(),a=r.LastName.toUpperCase(),o=n==="asc";if(t<a){return o?-1:1}if(t>a){return o?1:-1}return 0});return a}function T(e,r){var t,n,o=[].concat(r),i=e.url.match(/\$filter=.*\((.*),'(.*)'\)/);if(Array.isArray(i)&&i.length>=3){t=i[1];n=i[2];if(t!=="LastName"){throw new Error("Filters on field "+t+" are not supported.")}o=a.filter(function(e){return e.LastName.indexOf(n)!==-1})}return o}function b(){return[200,{"Content-Type":"application/xml","odata-version":"4.0"},o]}function N(){return v(a.length.toString())}function E(e,r){var t,n,o,i,s,u,c,f,d,h,y,b;n=e.url.match(/\$expand=([^&]+)/);if(n){o=n[0];o=o.substring(8);y=o.match(/\([^\)]*\)/g);for(b=0;b<y.length;b++){y[b]=y[b].replace(/\(\$select=/,"").replace(/\)/,"").split(",")}o=o.replace(/\([^\)]*\)/g,"");n=o.split(",")}d=e.url.match(/[^(]\$select=([\w|,]+)/);if(Array.isArray(d)){h=d[0];h=h.replace(/&/,"").replace(/\?/,"").substring(8);d=h.split(",")}s=p(e.url);if(s){i=l(s);if(/People\(.+\)\/Friends/.test(e.url)){u={value:[]};u.value=S(a[i].Friends,d)}else{u=O(i,d,n,y)}if(i>-1){c=JSON.stringify(u);return v(c)}c=m(s);return[400,{"Content-Type":"application/json; charset=utf-8"},c]}f=T(e,a);t=f.length;f=w(e,f);f=g(e,f);u={"@odata.count":t,value:[]};f.forEach(function(e){var r=l(e.UserName);u.value.push(O(r,d,n,y))});c=JSON.stringify(u);return v(c)}function P(e,r){var t={},n=a[e];if(n){r.forEach(function(e){t[e]=n[e]});return t}return null}function O(e,r,t,n){var o,i,s,u={},c,f;u=P(e,r);if(t){c=a[e];for(f=0;f<t.length;f++){switch(t[f]){case"Friends":u.Friends=[];s=c.Friends;u.Friends=S(s,n[f]);break;case"BestFriend":o=c.BestFriend;i=l(o);u.BestFriend=P(i,n[f]);break;default:break}}}return u}function S(e,r){var t=[],n;if(e){e.forEach(function(e){n=l(e);t.push(P(n,r))});t=t.filter(function(e){return e!=null})}return t}function k(e){var r,t,n,o,i;r=p(e.url);n=f(e.requestBody);if(n.hasOwnProperty("UserName")&&n.UserName!==r&&!d(n.UserName)){o=h(n.UserName);return[400,{"Content-Type":"application/json; charset=utf-8"},o]}t=a[l(r)];for(i in n){if(n.hasOwnProperty(i)){t[i]=n[i]}}o=null;return[204,{"OData-Version":"4.0"},o]}function F(e){var r;r=p(e.url);a.splice(l(r),1);return[204,{"OData-Version":"4.0"},null]}function q(e){var r,t;r=f(e.requestBody);if(d(r.UserName)){a.push(r);t='{"@odata.context": "'+c(e.url)+'$metadata#People/$entity",';t+=JSON.stringify(r).slice(1);return[201,{"Content-Type":"application/json; odata.metadata=minimal","OData-Version":"4.0"},t]}t=h(r.UserName);return[400,{"Content-Type":"application/json; charset=utf-8"},t]}function C(){y();return[204,{"OData-Version":"4.0"},null]}function R(e){var r;switch(e.method){case"GET":if(/\$metadata/.test(e.url)){r=b()}else if(/\/\$count/.test(e.url)){r=N()}else if(/People.*\?/.test(e.url)){r=E(e,/\$count=true/.test(e.url))}break;case"PATCH":if(/People/.test(e.url)){r=k(e)}break;case"POST":if(/People/.test(e.url)){r=q(e)}else if(/ResetDataSource/.test(e.url)){r=C()}break;case"DELETE":if(/People/.test(e.url)){r=F(e)}break;case"HEAD":r=[204,{}];break;default:break}return r}function L(e){var r,t="",n=e.requestBody.match(/(.*)/)[1],a,o,i=e.requestBody.split(n).slice(1,-1),s,u,l;u=i[0].match(/multipart\/mixed;boundary=(.+)/);if(u&&u.length>0){a=u[1];s=i[0].split("--"+a).slice(1,-1)}else{s=i}if(a){o="--"+a;t+=n+"\r\n"+"Content-Type: multipart/mixed; boundary="+a+"\r\n\r\n"}else{o=n}s.forEach(function(r,n){var i=r.match(/(GET|DELETE|PATCH|POST) (\S+)(?:.|\r?\n)+\r?\n(.*)\r?\n$/),s=R({method:i[1],url:c(e.url)+i[2],requestBody:i[3]});t+=o+"\r\n"+"Content-Type: application/http\r\n";if(a){t+="Content-ID:"+n+".0\r\n"}t+="\r\nHTTP/1.1 "+s[0]+"\r\n";if(s[1]&&s[0]!==204){for(l in s[1]){if(s[1].hasOwnProperty(l)){t+=l+": "+s[1][l]+"\r\n"}}}t+="\r\n";if(s[2]){t+=s[2]}t+="\r\n"});if(a){t+="--"+a+"--\r\n"}t+=n+"--";r=[200,{"Content-Type":"multipart/mixed;boundary="+n.slice(2),"OData-Version":"4.0"},t];return r}function U(e){var r;t.info("Mockserver: Received "+e.method+" request to URL "+e.url,(e.requestBody?"Request body is:\n"+e.requestBody:"No request body.")+"\n",s);if(e.method==="POST"&&/\$batch/.test(e.url)){r=L(e)}else{r=R(e)}e.respond(r[0],r[1],r[2]);t.info("Mockserver: Sent response with return code "+r[0],"Response headers: "+JSON.stringify(r[1])+"\n\nResponse body:\n"+r[2]+"\n",s)}});
//# sourceMappingURL=mockserver.js.map